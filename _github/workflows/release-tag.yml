# ==============================================================================
# ğŸ·ï¸ Release Validation - Tag-Based Version Consistency Check
# ==============================================================================
#
# Purpose: Validates version consistency between vcpkg.json and git tags
# before GitHub creates automatic source tarballs for distribution.
#
# Features:
# â€¢ Single source of truth: vcpkg.json version (CMakeLists.txt reads from vcpkg.json)
# â€¢ Support for all vcpkg.json version field variants (version, version-string, version-semver, etc.)
# â€¢ GitHub Actions UI integration with ::error:: annotations and collapsible debug logs
# â€¢ Clean semantic version restriction (v1.0.0 format) - no pre-release suffixes allowed
# â€¢ Fast validation (no CMake configuration required)
#
# Workflow Process:
# 1. Admin pushes semantic version tag (e.g., v1.0.8) to repository
# 2. validate-release job extracts version from vcpkg.json and compares with tag
# 3. If validation passes, GitHub automatically creates source tarball
# 4. Downstream publish.yml workflow can use validated tarball for vcpkg registry
#
# Trigger Pattern:
# â€¢ Only responds to clean semantic version tags: v1.0.0, v2.1.3, etc.
# â€¢ Rejects pre-release tags: v1.0.0-alpha, v1.0.0-beta, v1.0.0-rc1
# ==============================================================================

name: ğŸ·ï¸ Release Validation

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'  # Only clean versions (v1.0.0), no suffixes for now

jobs:
  # ==============================================================================
  # Release Validation Job - Extract and Compare Version Numbers
  # ==============================================================================
  # Validates version consistency between vcpkg.json and git tag.
  # No CMake configuration required since CMakeLists.txt reads from vcpkg.json.
  validate-release:
    name: ğŸ·ï¸ Validate â€¢ Release Tag
    runs-on: ubuntu-22.04
    timeout-minutes: 10
    
    steps:
      - name: Checkout Source
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Extract Tag Version
        id: tag
        run: |
          # Extract version from tag (remove 'v' prefix)
          TAG_WITH_V=${GITHUB_REF#refs/tags/}
          TAG_VERSION=${TAG_WITH_V#v}
          echo "TAG_WITH_V=$TAG_WITH_V" >> $GITHUB_ENV
          echo "TAG_VERSION=$TAG_VERSION" >> $GITHUB_ENV

      - name: Install Python (for vcpkg.json parsing)
        timeout-minutes: 2
        run: |
          # Install Python for vcpkg.json version extraction
          sudo apt-get update
          sudo apt-get install -y python3

      - name: Extract vcpkg.json Version
        id: vcpkg-version
        run: |
          echo "::group::Extract vcpkg.json version using Python script"
          
          # Use standalone Python script to extract version
          VCPKG_VERSION=$(python3 .github/scripts/extract_vcpkg_version.py)
          
          if [ -z "$VCPKG_VERSION" ]; then
            echo "::error::Failed to extract version from vcpkg.json"
            exit 1
          fi
          
          echo "Extracted vcpkg version: $VCPKG_VERSION"
          echo "VCPKG_VERSION=$VCPKG_VERSION" >> $GITHUB_ENV
          echo "vcpkg-version=$VCPKG_VERSION" >> $GITHUB_OUTPUT
          echo "::endgroup::"

      - name: Validate Version Consistency
        run: |
          echo "ğŸ¯ Version Consistency Check (vcpkg.json â†” Git Tag):"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Tag      : $TAG_VERSION"
          echo "vcpkg    : $VCPKG_VERSION"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          if [ -z "$VCPKG_VERSION" ]; then
            echo "::error::Failed to extract version from vcpkg.json"
            echo "âŒ Failed to extract vcpkg.json version!"
            echo ""
            echo "   Check that ./vcpkg.json has a version field such as:"
            echo "   â€¢ \"version\": \"x.y.z\""
            echo "   â€¢ \"version-string\": \"x.y.z\""
            echo "   â€¢ \"version-semver\": \"x.y.z\""
            exit 1
          fi

          if [ "$VCPKG_VERSION" != "$TAG_VERSION" ]; then
            echo "::error::Version mismatch! Tag=$TAG_VERSION, vcpkg=$VCPKG_VERSION"
            echo "âŒ Version mismatch!"
            echo ""
            echo "   Tag      : $TAG_VERSION"
            echo "   vcpkg    : $VCPKG_VERSION"
            echo ""
            echo "Please update ./vcpkg.json to match tag version."
            echo "Note: CMakeLists.txt automatically reads version from vcpkg.json"
            exit 1
          fi

          echo "âœ… Versions aligned:"
          echo "   Tag      : $TAG_WITH_V"
          echo "   vcpkg    : $VCPKG_VERSION"
          echo "   CMake    : Reads from vcpkg.json automatically"
          echo "   Tarball  : https://github.com/${{ github.repository }}/archive/refs/tags/$TAG_WITH_V.tar.gz"
          echo ""
          echo "ğŸ‰ Release validation passed! GitHub will create the source tarball automatically."